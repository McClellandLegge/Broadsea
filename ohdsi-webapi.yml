version: '3.9'

services:

  ohdsi-webapi:
    container_name: ohdsi-webapi
    platform: ${DOCKER_ARCH}
    restart: unless-stopped
    ipc: none
    read_only: true
    tmpfs:
      - /tmp
    privileged: false
    environment:
      SECURITY_PROVIDER: ${WEBAPI_SECURITY_PROVIDER}
      DATASOURCE_DRIVERCLASSNAME: org.postgresql.Driver
      DATASOURCE_URL: ${WEBAPI_DATASOURCE_URL}
      DATASOURCE_USERNAME: ${WEBAPI_DATASOURCE_USERNAME}
      DATASOURCE_PASSWORD: ${WEBAPI_DATASOURCE_PASSWORD}
      DATASOURCE_OHDSI_SCHEMA: ${WEBAPI_DATASOURCE_OHDSI_SCHEMA}
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.PostgreSQLDialect
      SPRING_JPA_PROPERTIES_HIBERNATE_DEFAULT_SCHEMA: ${WEBAPI_DATASOURCE_OHDSI_SCHEMA}
      SPRING_BATCH_REPOSITORY_TABLEPREFIX: ${WEBAPI_DATASOURCE_OHDSI_SCHEMA}.BATCH_
      FLYWAY_DATASOURCE_DRIVERCLASSNAME: org.postgresql.Driver
      FLYWAY_DATASOURCE_URL: ${WEBAPI_DATASOURCE_URL}
      FLYWAY_DATASOURCE_USERNAME: ${WEBAPI_DATASOURCE_USERNAME}
      FLYWAY_DATASOURCE_PASSWORD: ${WEBAPI_DATASOURCE_PASSWORD}
      FLYWAY_LOCATIONS: classpath:db/migration/postgresql
      FLYWAY_PLACEHOLDERS_OHDSISCHEMA: ${WEBAPI_DATASOURCE_OHDSI_SCHEMA}
      FLYWAY_SCHEMAS: ${WEBAPI_DATASOURCE_OHDSI_SCHEMA}
      FLYWAY_BASELINEONMIGRATE: "true"
      FLYWAY_TABLE: schema_history
      flyway_baselineVersionAsString: "2.2.5.20180212152023"  # this env var is case sensitive
      FLYWAY_BASELINEDESCRIPTION: Base Migration
      SECURITY_CORS_ENABLED: "true"
      SECURITY_ORIGIN: "${HTTP_TYPE}://${BROADSEA_HOST}"
      SOLR_ENDPOINT: "${SOLR_ENDPOINT}"

      # Security env variables - Basic

      # Security env variables - LDAP
      SECURITY_LDAP_DN: ${SECURITY_LDAP_DN}
      SECURITY_LDAP_URL: ${SECURITY_LDAP_URL}
      SECURITY_LDAP_BASEDN: ${SECURITY_LDAP_BASEDN}
      SECURITY_LDAP_SYSTEM_USERNAME: ${SECURITY_LDAP_SYSTEM_USERNAME}
      SECURITY_LDAP_SYSTEM_PASSWORD: ${SECURITY_LDAP_SYSTEM_PASSWORD}
      SECURITY_LDAP_SEARCHSTRING: ${SECURITY_LDAP_SEARCHSTRING}
      SECURITY_LDAP_SEARCHBASE: ${SECURITY_LDAP_SEARCHBASE}

      # Security env variables - AD

      # Security env variables - Kerberos

      # Security env variables - OAuth

      # Security env variables - OpenID

      # Security env variables - IAP

      

      # Security env variables - CAS
      SECURITY_OAUTH_CALLBACK_UI: ${HTTP_TYPE}://${BROADSEA_HOST}/atlas/#/welcome
      SECURITY_CAS_LOGINURL: ${HTTP_TYPE}://${WEBAPI_SECURITY_CAS_SERVER}/idp/profile/cas/login
      SECURITY_CAS_CALLBACKURL: ${HTTP_TYPE}://${BROADSEA_HOST}/WebAPI/user/cas/callback?client_name=CasClient
      SECURITY_CAS_SERVERURL: ${HTTP_TYPE}://${WEBAPI_SECURITY_CAS_SERVER}/idp/profile/cas
      SECURITY_CAS_CASTICKET: ticket

    labels:
      - "traefik.enable=true"